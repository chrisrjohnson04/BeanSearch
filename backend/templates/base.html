<!DOCTYPE html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
  rel="stylesheet"
/>
<!-- test -->
<body>
  <div id="everything">
    <aside id="filters-container" style="display: none">
      <div class="roast-filter">
        <div class="roast-dropdown">
          <button onclick="toggleRoastDropdown()" class="roast-dropbtn">
            Select Roasts
          </button>
          <div id="roastDropdown" class="roast-dropdown-content">
            <label
              ><input
                type="checkbox"
                name="roast"
                value="Light"
                onchange="filterText()"
              />
              Light</label
            >
            <label
              ><input
                type="checkbox"
                name="roast"
                value="Medium-Light"
                onchange="filterText()"
              />
              Medium-Light</label
            >
            <label
              ><input
                type="checkbox"
                name="roast"
                value="Medium"
                onchange="filterText()"
              />
              Medium</label
            >
            <label
              ><input
                type="checkbox"
                name="roast"
                value="Medium-Dark"
                onchange="filterText()"
              />
              Medium-Dark</label
            >
            <label
              ><input
                type="checkbox"
                name="roast"
                value="Dark"
                onchange="filterText()"
              />
              Dark</label
            >
          </div>
        </div>
      </div>
      <div class="price-filter">
        <div class="price-slider-container">
          <label for="max-price"
            >Max Price (per 100g): $<span id="price-value">40</span></label
          >
          <input
            type="range"
            id="max-price"
            name="max-price"
            min="5"
            max="40"
            step="5"
            value="40"
            onchange="updatePriceLabel(); filterText();"
            oninput="updatePriceLabel();"
          />
          <div class="price-ticks">
            <span>$5</span>
            <span>$10</span>
            <span>$15</span>
            <span>$20</span>
            <span>$25</span>
            <span>$30</span>
            <span>$35</span>
            <span>$40</span>
          </div>
        </div>
      </div>
    </aside>
    <div class="full-body-container">
      <div class="top-text">
        <div class="google-colors">
          <h1>Bean Search</h1>
          <h2>Espresso Yourself</h2>
        </div>
        <div class="input-box" onclick="sendFocus()">
          <img src="{{ url_for('static', filename='images/mag.png') }}" />
          <input
            placeholder="Search for a coffee bean"
            id="filter-text-val"
            onkeyup="filterText()"
          />
        </div>
        <div class="svd-toggle-container">
          <label class="svd-toggle">
            <input type="checkbox" id="use-svd" onchange="filterText()" />
            <span class="svd-toggle-label">Use SVD Search</span>
            <span class="svd-tooltip"
              >(Uses machine learning to find beans based on meaning, not just
              keywords)</span
            >
          </label>
        </div>
      </div>
      <div id="answer-box"></div>
    </div>
  </div>
  <script>
    function answerBoxTemplate(bean) {
      const scoreDisplay = bean.match_score
        ? `<p class="bean-score">Match Score: ${bean.match_score}</p>`
        : "";
      return `<div class='bean-result'>
                <h3 class='bean-name'>${bean.name} [${bean.roaster} - ${bean.loc_country}]</h3>
                <p class='bean-desc'>${bean.desc}</p>
                <p class='bean-rating'>Review Rating: ${bean.rating}</p>
                <p class='bean-rating'>Price (/100g): ${bean["100g_USD"]}</p>
                <p class='bean-rating'>Roast: + ${bean.roast}</p>
                <p class='bean-rating'>Bean Origin(s): ${bean.origin_1}, ${bean.origin_2}</p>
                ${scoreDisplay}
            </div>`;
    }

    function sendFocus() {
      document.getElementById("filter-text-val").focus();
    }

    function toggleRoastDropdown() {
      document.getElementById("roastDropdown").classList.toggle("show");
    }

    function updatePriceLabel() {
      const priceSlider = document.getElementById("max-price");
      const priceValueDisplay = document.getElementById("price-value");
      priceValueDisplay.textContent = priceSlider.value;
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (event) {
      if (!event.target.matches(".roast-dropbtn")) {
        var dropdowns = document.getElementsByClassName(
          "roast-dropdown-content"
        );
        for (var i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains("show")) {
            openDropdown.classList.remove("show");
          }
        }
      }
    };

    function filterText() {
      document.getElementById("answer-box").innerHTML =
        "<div class='loading'>Searching beans...</div>";
      const searchQuery = document.getElementById("filter-text-val").value;
      const maxPrice = document.getElementById("max-price").value;
      const useSVD = document.getElementById("use-svd").checked;

      // Get all selected roast types
      const selectedRoasts = [];
      const checkboxes = document.querySelectorAll(
        'input[name="roast"]:checked'
      );
      checkboxes.forEach((checkbox) => {
        selectedRoasts.push(checkbox.value);
      });

      fetch(
        "/beans?" +
          new URLSearchParams({
            bean_query: searchQuery,
            roast_types: selectedRoasts.join(","),
            max_price: maxPrice,
            use_svd: useSVD,
          }).toString()
      )
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("filters-container").style.display = "block";
          document.getElementById("answer-box").innerHTML = "";

          if (data.length === 0) {
            document.getElementById("answer-box").innerHTML =
              "<p class='no-results'>No matching coffee beans found. Try adjusting your filters or search terms.</p>";
          } else {
            data.forEach((row) => {
              let tempDiv = document.createElement("div");
              tempDiv.innerHTML = answerBoxTemplate(row);
              document.getElementById("answer-box").appendChild(tempDiv);
            });
          }
        })
        .catch((error) => {
          console.error("Error fetching results:", error);
          document.getElementById("answer-box").innerHTML =
            "<p class='error-message'>Error loading results. Please try again.</p>";
        });
    }
    const examples = [
      "Search for a coffee bean",
      "Search for Yirgacheffe with citrus and bright floral hints",
      "Search for nutty flavored bean from Mexico",
    ];

    const typeSpeed = 75;
    const deleteSpeed = 50;
    const pauseTime = 2000;

    let exampleIndex = 0;
    let charIndex = 0;
    let isDeleting = false;

    function typeWriterEffect() {
      const input = document.getElementById("filter-text-val");
      const currentText = examples[exampleIndex];

      if (!isDeleting) {
        input.placeholder = currentText.substring(0, charIndex + 1);
        charIndex++;

        if (charIndex === currentText.length) {
          isDeleting = true;
          setTimeout(typeWriterEffect, pauseTime);
        } else {
          setTimeout(typeWriterEffect, typeSpeed);
        }
      } else {
        input.placeholder = currentText.substring(0, charIndex - 1);
        charIndex--;

        if (charIndex === 10) {
          isDeleting = false;
          exampleIndex = (exampleIndex + 1) % examples.length;
          setTimeout(typeWriterEffect, pauseTime / 2);
        } else {
          setTimeout(typeWriterEffect, deleteSpeed);
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      typeWriterEffect();
    });
  </script>
</body>
